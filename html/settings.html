<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± ESP-12E ESP8266 - –ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 7px;
            margin: 7px;
            background: #f5f5f5
        }
        .container {
            max-width: 650px;
            background: white;
            padding: 14px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin: 0 auto;
        }
        .panel {
            background: #e8f4fd;
            padding: 14px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .btn-nav {
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            gap: 7px;
        }
        .btn-nav a {
            display: inline-block;
            padding: 8px 16px;
            background: #1a73e8;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        h2 {
            color: #1a73e8;
            text-align: center;
            margin: 0;
            font-size: 1.4rem;
        }
        .panel-title {
            margin: 0;
            padding-bottom: 7px;
            border-bottom: 1px solid #d0e8fc;
        }
        .panel-row {
            display: flex;
            font-size: 0.9rem;
        }
        .panel-row > *{
            width: 100%;
            vertical-align: text-bottom;
        }
        .panel-row > .panel-value:nth-child(3) {
            color: #666; 
            font-style: italic; 
            text-align: right;
        }
        .panel-label {
            font-weight: bold;
            color: #5f6368;
            padding-right: 8px;
        }
        .panel-value {
            color: #202124;
        }
    </style>
</head>
<body>
    <div class='container'>

        <div class="panel">
            <div class="btn-nav">
                <a href="/">–°—Ç–∞—É—Å</a>
                <a href="/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                <a href="/sensors">–î–∞—Ç—á–∏–∫–∏</a>
                <a href="/attributes">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</a>
            </div>
        </div>

        <h2>üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Wi-Fi</h2>

        <div class='panel'>
            <h3 class="panel-title">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–π</h3>
            <div id="scanStatus" class="loading">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ç–µ–π...</div>
            <div id="networksList"></div>
            <button onclick="scanNetworks()" id="scanBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        </div>

        <div class='panel'>
            <h3 class="panel-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏</h3>
            <form method='POST' action='/save' id="wifiForm">
                <div class='form-group'>
                    <label for='ssid'>–ò–º—è —Å–µ—Ç–∏ (SSID):</label>
                    <input type='text' id='ssid' name='ssid' placeholder='–í–≤–µ–¥–∏—Ç–µ SSID' required>
                </div>
                <div class='form-group'>
                    <label for='password'>–ü–∞—Ä–æ–ª—å:</label>
                    <input type='password' id='password' name='password' placeholder='–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å' required>
                </div>
                <button type='submit'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </form>
        </div>

        <div class='panel'>
            <h3 class="panel-title">–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h3>
            <div id="currentConfig" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫...</div>
        </div>

        <script>
            // –§—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ç–µ–π
            function scanNetworks() {
                const scanBtn = document.getElementById('scanBtn');
                const scanStatus = document.getElementById('scanStatus');
                const networksList = document.getElementById('networksList');
                
                scanBtn.disabled = true;
                scanStatus.textContent = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...';
                networksList.innerHTML = '';
                
                fetch('/api/networks')
                    .then(response => response.json())
                    .then(data => {
                        if (data.networks && data.networks.length > 0) {
                            scanStatus.textContent = `–ù–∞–π–¥–µ–Ω–æ ${data.networks.length} —Å–µ—Ç–µ–π:`;
                            data.networks.forEach(network => {
                                const networkDiv = document.createElement('div');
                                networkDiv.className = 'network-item';
                                networkDiv.innerHTML = `
                                    <div class="network-info">
                                        <div class="network-name">${network.ssid}</div>
                                        <div class="network-rssi">–°–∏–≥–Ω–∞–ª: ${network.rssi} dBm</div>
                                    </div>
                                    <button class="network-select" onclick="selectNetwork('${network.ssid}')">–í—ã–±—Ä–∞—Ç—å</button>
                                `;
                                networksList.appendChild(networkDiv);
                            });
                        } else {
                            scanStatus.textContent = '–°–µ—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                        }
                    })
                    .catch(error => {
                        scanStatus.textContent = '–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è';
                        console.error('–û—à–∏–±–∫–∞:', error);
                    })
                    .finally(() => {
                        scanBtn.disabled = false;
                    });
            }

            // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Å–µ—Ç–∏
            function selectNetwork(ssid) {
                document.getElementById('ssid').value = ssid;
                document.getElementById('password').focus();
            }

            // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            function loadCurrentConfig() {
                fetch('/api/config')
                    .then(response => response.json())
                    .then(data => {
                        const configDiv = document.getElementById('currentConfig');
                        if (data.configured) {
                            configDiv.innerHTML = `
                                <div class="status status-success">
                                    ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫: <strong>${data.ssid}</strong>
                                </div>
                            `;
                        } else {
                            configDiv.innerHTML = `
                                <div class="status status-info">
                                    ‚ÑπÔ∏è –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        const configDiv = document.getElementById('currentConfig');
                        configDiv.innerHTML = `
                            <div class="status status-error">
                                ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                            </div>
                        `;
                        console.error('–û—à–∏–±–∫–∞:', error);
                    });
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.addEventListener('DOMContentLoaded', function() {
                scanNetworks();
                loadCurrentConfig();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
                document.getElementById('wifiForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                    
                    const formData = new FormData(this);
                    fetch('/save', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!\n–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...');
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 3000);
                        } else {
                            throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                        }
                    })
                    .catch(error => {
                        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                        console.error('–û—à–∏–±–∫–∞:', error);
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
                });
            });
        </script>
    </div>
    
    </div>
</body>
</html>