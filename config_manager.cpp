// config_manager.cpp - Реализация управления конфигурацией устройства

// Зависимости
#include "config_manager.h"
#include <LittleFS.h>

// Определение глобальной переменной конфигурации с значениями по умолчанию
// Инициализируется при запуске программы
SystemConfig config = {
  "",                    // wifiSSID - пустая строка (нет сохраненной сети)
  "",                    // wifiPassword - пустая строка (нет сохраненного пароля)  
  1,                     // maxClients - максимум 1 клиент для точки доступа
  5,                     // updateInterval - обновление данных каждые 5 секунд
  false,                 // firstSetupDone - настройка не выполнена
  22.0,                  // tempBase - базовая температура 22°C
  3.0,                   // tempAmplitude - колебания ±3°C
  45.0,                  // humBase - базовая влажность 45%
  10.0                   // humAmplitude - колебания ±10%
};

/**
 * Функция загрузки конфигурации из файловой системы
 * 
 * Алгоритм работы:
 * 1. Инициализация LittleFS (если не удается - выход без ошибки)
 * 2. Проверка существования файла /config.dat
 * 3. Если файл существует - чтение бинарных данных напрямую в структуру
 * 4. Закрытие файла
 * 
 * Особенности:
 * - Безопасна для первого запуска (когда файла еще нет)
 * - Чтение выполняется побайтово без парсинга (высокая производительность)
 * - Не изменяет значения по умолчанию, если файл не найден
 */
void loadConfig() {
  // Инициализация файловой системы
  if (!LittleFS.begin()) return;
  
  // Проверка существования файла конфигурации
  if (LittleFS.exists("/config.dat")) {
    // Открытие файла для чтения
    File file = LittleFS.open("/config.dat", "r");
    if (file) {
      // Чтение бинарных данных напрямую в структуру конфигурации
      // sizeof(SystemConfig) гарантирует чтение правильного количества байт
      file.readBytes((char*)&config, sizeof(SystemConfig));
      file.close();
    }
  }
}

/**
 * Функция сохранения конфигурации в файловую систему
 * 
 * Алгоритм работы:
 * 1. Инициализация LittleFS (если не удается - выход без ошибки)
 * 2. Открытие файла /config.dat для записи (создание или перезапись)
 * 3. Запись бинарных данных структуры config в файл
 * 4. Закрытие файла
 * 
 * Особенности:
 * - Перезаписывает существующий файл полностью
 * - Запись выполняется побайтово без сериализации (высокая производительность)
 * - Создает файл, если он не существует
 */
void saveConfig() {
  // Инициализация файловой системы
  if (!LittleFS.begin()) return;
  
  // Открытие файла для записи (режим "w" создает или перезаписывает)
  File file = LittleFS.open("/config.dat", "w");
  if (file) {
    // Запись бинарных данных структуры конфигурации
    // Преобразование указателя к uint8_t* для корректной записи
    file.write((uint8_t*)&config, sizeof(SystemConfig));
    file.close();
  }
}

/**
 * Функция проверки завершения первоначальной настройки
 * 
 * Простая обертка над полем firstSetupDone структуры config.
 * Обеспечивает читаемый интерфейс для других модулей.
 * 
 * Возвращает: bool - значение поля firstSetupDone
 */
bool isFirstSetupDone() {
  return config.firstSetupDone;
}